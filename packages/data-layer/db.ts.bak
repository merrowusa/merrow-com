// @version data-layer-db v3.0 (PostgreSQL - LAZY)
//
// PostgreSQL connection for Merrow databases via Supabase
// DEPRECATED: Use supabase.ts for all new code (Vercel can't reach Postgres)
//
// This file uses lazy initialization to prevent connection attempts
// during Next.js build when DATABASE_URL may not be available.

import { drizzle, PostgresJsDatabase } from "drizzle-orm/postgres-js";
import postgres, { Sql } from "postgres";
import * as schema from "./schema";

let clientInstance: Sql | null = null;
let dbInstance: PostgresJsDatabase<typeof schema> | null = null;

/**
 * Get PostgreSQL client (lazy initialization)
 * @deprecated Use supabase.ts instead - Vercel builds can't reach Postgres
 */
function getClient(): Sql | null {
  if (clientInstance) return clientInstance;

  const connectionString = process.env.DATABASE_URL;
  if (!connectionString) {
    // Don't throw - just return null. Caller should use supabase.ts instead.
    return null;
  }

  clientInstance = postgres(connectionString, { prepare: false });
  return clientInstance;
}

/**
 * Get Drizzle database instance (lazy initialization)
 * @deprecated Use supabase.ts instead - Vercel builds can't reach Postgres
 * @returns Database instance or null if DATABASE_URL not set
 */
export function getDb(): PostgresJsDatabase<typeof schema> | null {
  if (dbInstance) return dbInstance;
  const client = getClient();
  if (!client) return null;
  dbInstance = drizzle(client, { schema });
  return dbInstance;
}

// Legacy exports using Proxy for backward compatibility
// Returns undefined for all properties when DATABASE_URL not set (safe no-op)
export const db = new Proxy({} as PostgresJsDatabase<typeof schema>, {
  get(_, prop) {
    const instance = getDb();
    if (!instance) return undefined;
    return (instance as unknown as Record<string, unknown>)[prop as string];
  },
});

export const pool = new Proxy({} as Sql, {
  get(_, prop) {
    const instance = getClient();
    if (!instance) return undefined;
    return (instance as unknown as Record<string, unknown>)[prop as string];
  },
});
